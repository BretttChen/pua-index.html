<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>æƒ…å‹’ä¿±æ¨‚éƒ¨ï¼šç·¨å¹´å²</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        :root {
            --vh: 1vh;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #050505; 
            margin: 0; 
            /* é˜²æ­¢è¡Œå‹•è£ç½®ä½ç§» */
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden; 
        }
        
        #loading {
            color: #ff00ff; display: flex; justify-content: center; align-items: center;
            height: 100vh; font-family: monospace; font-size: 20px; background: #000; text-align: center;
        }

        .glitch-text { text-shadow: 2px 2px 0px #ff0055, -2px -2px 0px #00ffff; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .animate-shake { animation: shake 0.5s; }

        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        .animate-float-up { animation: float-up 1.5s ease-out forwards; }

        @keyframes glitch-screen {
            0% { clip-path: inset(40% 0 61% 0); transform: translate(-2px, 2px); }
            20% { clip-path: inset(92% 0 1% 0); transform: translate(2px, -1px); filter: hue-rotate(90deg); }
            40% { clip-path: inset(43% 0 1% 0); transform: translate(1px, 3px); }
            60% { clip-path: inset(25% 0 58% 0); transform: translate(2px, 2px); }
            80% { clip-path: inset(54% 0 7% 0); transform: translate(-1px, -2px); filter: hue-rotate(-90deg); }
            100% { clip-path: inset(58% 0 43% 0); transform: translate(2px, 1px); }
        }
        .animate-glitch-screen { animation: glitch-screen 0.3s linear infinite; }
    </style>
    
    <script>
        // è™•ç†è¡Œå‹•ç‰ˆç€è¦½å™¨å·¥å…·åˆ—å°è‡´çš„é«˜åº¦å•é¡Œ
        function setVh() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', setVh);
        window.addEventListener('orientationchange', setVh);
        setVh();

        window.onerror = function(message) {
            if (message.includes("ResizeObserver loop")) return;
            console.error(message);
        };
    </script>
</head>
<body>
    <div id="root">
        <div id="loading">æ­£åœ¨åŠ å…¥æƒ…å‹’ä¸­~</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = window.React;

        // --- Icons ---
        const IconBase = ({ size = 24, className, children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Shield = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></IconBase>;
        const Heart = (props) => <IconBase {...props}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></IconBase>;
        const Coins = (props) => <IconBase {...props}><circle cx="8" cy="8" r="6"></circle><path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path><path d="M7 6h1v4"></path><path d="M17.12 10.06C15.22 6.6 11.39 5.34 8 7.37"></path></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></IconBase>;
        const Monitor = (props) => <IconBase {...props}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></IconBase>;
        const Utensils = (props) => <IconBase {...props}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"></path></IconBase>;
        const HeartCrack = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path><path d="m12 13-3-3 2-2-3-3"></path></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconBase>;

        // --- Audio Engine ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            switch (type) {
                case 'click':
                    osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1); break;
                case 'skill_heavy':
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(20, now + 0.4);
                    gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                    osc.start(now); osc.stop(now + 0.4); break;
                case 'glitch':
                    osc.type = 'sawtooth';
                    for(let i=0; i<5; i++) osc.frequency.setValueAtTime(200 + Math.random()*500, now + i*0.05);
                    gainNode.gain.setValueAtTime(0.15, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3); break;
                case 'heal':
                    osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3);
                    gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3); break;
                case 'damage':
                    osc.type = 'square'; osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(100, now + 0.1);
                    gainNode.gain.setValueAtTime(0.15, now); gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1); break;
            }
        };

        // --- Data Blueprint ---
        const CHANNELS = [
            { id: 'chat', name: 'æ–‡å­—èŠå¤©', icon: MessageSquare, desc: 'å·²è®€ä¸å›æ˜¯æœ€å¤§çš„æ…ˆæ‚²', type: 'social', color: 'text-blue-400',
              good: ["å¤§å®¶ç†±çƒˆå›æ‡‰ä½ çš„è²¼åœ–ï¼Œè¦ºå¾—è‡ªå·±é‚„æ˜¯å—æ­¡è¿çš„ã€‚", "æœ‰äººä¸»å‹•é—œå¿ƒä½ ä»Šå¤©éå¾—å¥½å—ï¼Œå¿ƒåº•æ¹§èµ·æš–æ„ã€‚"],
              bad: ["ä½ å‚³äº†è²¼åœ–ï¼Œä½†ç¾¤çµ„ç¬é–“å†·å ´ï¼Œæ²’äººç†ä½ ã€‚", "ç™¼ç¾ä½ çš„ç™¼è¨€è¢«æˆªåœ–åˆ°å¦ä¸€å€‹å°ç¾¤çµ„å˜²ç¬‘ã€‚"] },
            { id: 'valorant', name: 'ç“¦ç¾…è˜­', icon: Monitor, desc: 'é€™è£¡åªæœ‰æˆ°çŠ¯æ²’æœ‰éšŠå‹', type: 'combat', color: 'text-red-500',
              good: ["é€™å ´æ‰‹æ„Ÿç™¼ç‡™ï¼ŒCARRYå…¨å ´ï¼ŒéšŠå‹ç¨±è®šä½ æ˜¯ç¥ã€‚", "é‡åˆ°å‹å–„æºé€šçš„éšŠå‹ï¼Œé †åˆ©çˆ¬åˆ†ï¼Œå¿ƒæƒ…å¤§å¥½ã€‚"],
              bad: ["æˆ°çŠ¯èšé›†ã€‚è¢«éšŠå‹å˜´åˆ°æ‡·ç–‘äººç”Ÿï¼Œæ°£æ°›æ¥µåº¦æƒ¡åŠ£ã€‚", "é€£çºŒé‡åˆ°å¤–æ›èˆ‡æ›ç¶²ä»”ï¼Œå¿ƒæ…‹å¾¹åº•ç‚¸è£‚ã€‚"] },
            { id: 'maple', name: 'æ¥“ä¹‹è°·', icon: TrendingUp, desc: 'ç‡’éŒ¢ç‡’é™°å¾·ï¼Œè™›åº¦å…‰é™°', type: 'farm', color: 'text-green-400',
              good: ["æ‰“æ€ªæ‰è½äº†ç¨€æœ‰é“å…·ï¼Œå°è³ºä¸€ç­†ä½†æ²’æœ‰è®Šç¾ã€‚", "è·Ÿå…¬æœƒæˆå“¡æ„‰å¿«èŠå¤©ï¼Œåº¦éäº†å¹³éœçš„æ™‚å…‰ã€‚"],
              bad: ["è¡è£é€£çºŒå¤±æ•—ï¼Œå‚¾å®¶è•©ç”¢ï¼Œæ„Ÿåˆ°ç„¡æ¯”ç©ºè™›ã€‚", "è¢«è·¯äººæ¶æ€ªé‚„è¢«å˜²è«·ï¼Œæ°£åˆ°ç ¸æ»‘é¼ ã€‚"] },
            { id: 'tft', name: 'è¯ç›Ÿæˆ°æ——', icon: Activity, desc: 'åæ­£ä½ ä¸‹ä¸€æŠŠé‚„æ˜¯æœƒè¼¸', type: 'strategy', color: 'text-yellow-400',
              good: ["é™£å®¹é †åˆ©æˆå‹ï¼ŒæˆåŠŸåƒé›ï¼Œæ™ºå•†å£“åˆ¶å…¨å ´ã€‚", "ç¥æŠ½ä¸‰æ˜Ÿäº”è²»å¡ï¼Œé«”é©—åˆ°æ¥µè‡´çš„å¤šå·´èƒºåˆ†æ³Œã€‚"],
              bad: ["è€å…«å‡ºå±€ï¼Œé‹æ°£æ¥µå·®ï¼Œè·Ÿä½ æ˜¯å€‹é­¯è›‡ä¸€æ¨£ã€‚", "è¢«ç™¼ç‰Œå“¡é‡å°ï¼Œæƒ³ç©çš„é™£å®¹å…¨éƒ¨åŒè¡Œã€‚"] },
            { id: 'movie', name: 'å½±åŸ', icon: Play, desc: 'å‡è£æˆ‘å€‘æœ‰æ­£å¸¸ç¤¾äº¤', type: 'leisure', color: 'text-purple-400',
              good: ["ç´„åˆ°äººä¸€èµ·çœ‹é›»å½±ï¼Œäº«å—äº†é›£å¾—çš„æ”¾é¬†æ™‚å…‰ã€‚", "é›»å½±åŠ‡æƒ…è¶…å¥½çœ‹ï¼Œç²å¾—äº†æ·±åˆ»çš„æƒ…æ„Ÿå…±é³´ã€‚"],
              bad: ["ç´„çœ‹é›»å½±ï¼Œé˜¿å‰è¦å»å¹¹68è™Ÿæ²’ç©ºï¼Œä½ åªå¥½è‡ªå·±å»ã€‚", "é›»å½±å¤ªçˆ›ï¼Œæµªè²»æ™‚é–“åˆæµªè²»éŒ¢ï¼Œå¿ƒæƒ…æ›´å·®äº†ã€‚"] }
        ];

        const SHELTER = { id: 'aying', name: 'é˜¿è‹±ç‚’éºµ', icon: Utensils, cost: 1, heal: 15 };

        const PROTAGONISTS = [
            { 
                id: 'meow', name: 'å£å–µå£å–µé†¬ (è­·æ ¡ç”Ÿ)', role: 'é å‚™å½¹æƒ…å‹’è­·å£«', 
                desc: 'æ“…é•·ç”¨å°ˆæ¥­è¡“èªåŒ…è£æƒ…ç·’å‹’ç´¢ã€‚ã€Œæˆ‘æ˜¯ç‚ºä½ å¥½ã€æ˜¯å¥¹çš„çµ‚æ¥µæ­¦å™¨ã€‚å£é ­ç¦ªã€Œå£å–µã€èƒ½å°è½è¦ºé€ æˆæ°¸ä¹…æ€§æå‚·ã€‚', 
                skill: 'æ ¸å¿ƒæ³¨å°„', skillIcon: 'ğŸ’‰', glow: 'hover:shadow-[0_0_20px_rgba(236,72,153,0.5)] border-pink-900/30' 
            },
            { 
                id: 'latte', name: 'æ‹¿éµ (å·¨é¾)', role: 'ç¤¾äº¤å‰å‰Šé­”', 
                desc: 'å¥³éƒåªæ˜¯æ¶ˆè€—å“ï¼Œå‰ä»»æ¯”é¬¼é‚„å¯æ€•ã€‚æ“…é•·ç„¡ç¸«æ¥è»Œèˆ‡æ•¸å€¼è½‰ç§»ã€‚ã€Œæˆ‘åªæ˜¯å¤ªå®³æ€•å¤±å»äº†ã€æ˜¯ä»–çš„èµ·æ‰‹å¼ã€‚', 
                skill: 'é‡æ‹³å‡ºæ“Š', skillIcon: 'ğŸ‘Š', glow: 'hover:shadow-[0_0_20px_rgba(239,68,68,0.5)] border-red-900/30' 
            },
            { 
                id: 'mao', name: 'æ¯› (ç‹‚æˆ°å£«)', role: 'ä»‡æ¨ç™¼å‹•æ©Ÿ', 
                desc: 'æ­§è¦–ç”¢ç”ŸåŠ›é‡ï¼Œè¢«æ”¾é´¿å­æœƒèµ·è‚–ã€‚ä¸€æ—¦å•Ÿå‹•ä»‡æ¨ç™¼å‹•æ©Ÿï¼Œå°‡å°å‘¨é­é€²è¡Œç„¡å·®åˆ¥çœŸå¯¦å‚·å®³ã€‚ã€Œé€™ä¸–ç•Œå°æˆ‘å¤ªä¸å…¬å¹³ã€æ˜¯ä»–çš„æ•™æ¢ã€‚', 
                skill: 'è¡æ’å¤–å‹', skillIcon: 'ğŸ’¥', glow: 'hover:shadow-[0_0_20px_rgba(249,115,22,0.5)] border-orange-900/30' 
            },
            { 
                id: 'caitou', name: 'èœé ­ (å‰ç¥¥ç‰©)', role: 'å­˜åœ¨æ„Ÿç¨€è–„', 
                desc: 'æ´»è‘—å°±æ˜¯è¢«ç¬‘ï¼Œå¥³éƒå¿…å®šè¢«å¼„ä¸Ÿçš„å»¢ç‰©ã€‚æ“…é•·ç”¨æ¥µä½çš„å§¿æ…‹æ›å–å¾®è–„çš„åŒæƒ…ã€‚ã€Œæˆ‘åˆæç ¸äº†å°ä¸å°ã€æ˜¯ä»–çš„æ—¥å¸¸ã€‚', 
                skill: '1212', skillIcon: 'ğŸ›¡ï¸', glow: 'hover:shadow-[0_0_20px_rgba(59,130,246,0.5)] border-blue-900/30' 
            }
        ];

        const INITIAL_MEMBERS = [
            { id: 'weapon', name: 'Weaponä¸»å¸­', status: 'active', role: 'ç¨è£æš´å›', gender: 'male' },
            { id: 'awei', name: 'é˜¿å‰', status: 'active', role: '68è™Ÿå°ˆå±¬å­å­', gender: 'male' },
            { id: 'fish', name: 'é­š', status: 'active', role: 'æ¯è¦ªç‹‚æˆ°å£«', gender: 'female' },
            { id: 'wang', name: 'æ±ªæ±ª', status: 'active', role: 'å¿…è¼¸è³­ç‹—', gender: 'male' },
            { id: 'azumii', name: 'Azumii', status: 'active', role: 'é«˜éšç¶ èŒ¶', gender: 'female' },
            { id: 'daqi', name: 'å¤§å¥‡', status: 'active', role: 'èˆ”ç‹—è£œå¸«', gender: 'male' },
            { id: 'potato', name: 'åœŸè±†', status: 'active', role: 'Må±¬æ€§ç¤¾ç•œ', gender: 'male' },
            { id: 'insect', name: 'éš±åˆºèŸ²', status: 'active', role: 'ç™½ç›®å·¨å¬°', gender: 'male' },
            { id: 'aji', name: 'é˜¿é›', status: 'npc', role: 'ç´…é¡ç¦æ°´', gender: 'female' },
            { id: 'sora', name: 'ç´¢æ‹‰é†¬', status: 'active', role: 'ç’°å¢ƒè§€æ¸¬è€…', gender: 'female' },
            { id: 'incheon', name: 'ä»å·å°‘å¥³', status: 'hidden', role: 'é«˜åˆ†æ®µå¹»å½±', gender: 'female' }
        ];

        const STORY_LINES = {
            act1: [
                "ã€ä¸»ç·šã€‘æ‹¿éµå¤±æˆ€äº†ï¼Œå°‡æ‚²æ†¤è½‰åŒ–ç‚ºç©åˆ†ï¼Œæ•´å ´æ²‰é»˜é–å®šæ±ºé¬¥è€…ã€‚",
                "ã€ä¸»ç·šã€‘æ­·æ™‚ä¸€å€‹æœˆï¼Œæ‹¿éµæˆç‚ºç¾¤çµ„é¦–ä½è¶…å‡¡ï¼Œæ¿€èµ·ç¾¤çµ„ç«¶æŠ€å…§å·é–‹ç«¯ã€‚",
                "ã€äº‹ä»¶ã€‘é˜¿é›è¢«é¨·æ“¾...",
                "ã€ä¸»ç·šã€‘ç“¦ç¾…è˜­æ’ä½å¼•ç™¼åŠ‡çƒˆæ‘©æ“¦ï¼ŒWeapon ä¸»å¸­åˆ©ç”¨ç³»çµ±æ¼æ´å•Ÿå‹•ã€çµ•å°ç¨è£ã€‘ï¼Œæ²’æ”¶çœ¾äººç™¼è¨€æ¬Šã€‚",
                "ã€ä¸»ç·šã€‘Tyler èˆ‡å°é›…ç¢ºç«‹ç‚ºé ‚ç´šæˆ°åŠ›ï¼›èœé ­å› å£ç¿’æ…£å±¢é­å«Œæ£„ã€‚ç´¢æ‹‰é†¬å› ç’°å¢ƒè®ŠåŒ–é€²å…¥æ·¡å‡ºå€’æ•¸ã€‚",
                "ã€ä¸»ç·šã€‘é˜¿å‰é »ç¹æŠ½å–å…±ç”¨é‡‘å¹£ï¼Œè©¦åœ–å°‹æ‰¾ã€Œ68è™ŸæŠ€å¸«ã€ç·©è§£å£“åŠ›ã€‚",
                "ã€ä¸»ç·šã€‘é­šå°é˜¿å‰ç™¼å‹•ã€é€¼å©šã€‘æŠ€èƒ½ï¼Œéš±å½¢çš„æƒ…å‹’å£“åŠ›æ©è“‹äº†è³‡é‡‘éˆå³å°‡æ–·è£‚çš„çœŸç›¸ã€‚",
                "ã€ä¸»ç·šã€‘æ±ªæ±ªæ‹’çµ•äº†å¤§å¥‡çš„ç´”æ„›æ²»ç™’ï¼Œå°‡æ®˜å­˜è³‡æºå…¨å£“åœ¨å¾·å·æ’²å…‹ä¸Šï¼Œä¸¦é­é‡ Azumii æƒ¡æ„è©æ¬ºã€‚",
                "ã€ä¸»ç·šã€‘æ±ªæ±ªè³‡é‡‘èˆ‡ SAN å€¼å¾¹åº•æ­¸é›¶ï¼Œè§¸ç™¼çµ•å°äº‹ä»¶ã€ç™»å‡ºä¿±æ¨‚éƒ¨ã€‘ã€‚"
            ],
            act2: [
                "ã€ä¸»ç·šã€‘ç³»çµ±åº•å±¤é‚è¼¯ç•°è®Šç‚ºã€Œé«˜å£“ä»‡å¥³é ˜åŸŸã€ï¼Œå¥³æ€§æ¨™ç±¤å–®ä½ç”Ÿå‘½é€±æœŸæ¥µé€Ÿç¸®çŸ­ã€‚",
                "ã€ä¸»ç·šã€‘æ‹¿éµç™¼å±•å‡ºç—…æ…‹é©æ‡‰ï¼Œé«˜é »æ‹›å‹Ÿã€Œæ‹¿éµå¥³éƒã€ä½œç‚ºæ¶ˆè€—å“ã€‚",
                "ã€ä¸»ç·šã€‘æ‹¿éµåœ¨å¥³éƒç”Ÿå‘½é€±æœŸè€—ç›¡å‰ç™¼å‹•ã€é‡æ‹³å‡ºæ“Šã€‘ï¼Œå¼·åˆ¶åˆ†æ‰‹è½‰æ›ç‚ºè‡ªèº«æ•¸å€¼ã€‚",
                "ã€ä¸»ç·šã€‘èœé ­è©¦åœ–åœ¨èŠå¤©å€ä¿è­·å¥³éƒï¼Œä½†åœ¨ç„¡è™•ä¸åœ¨çš„æƒ¡æ„ä¸‹é€ä¸€å¼„ä¸Ÿï¼Œç¢ºç«‹å…¶ç„¡åŠ›çš„å‰ç¥¥ç‰©å®šä½ã€‚",
                "ã€ä¸»ç·šã€‘æ±ªæ±ªç•™ä¸‹çš„å”¯ä¸€ç—•è·¡ã€Œä»å·å°‘å¥³ã€ï¼Œé€æ¼¸å–ä»£æ±ªæ±ªæˆç‚ºæœ€é«˜ç‰Œä½ã€‚",
                "ã€ä¸»ç·šã€‘ä»å·å°‘å¥³èµ°å‘è¿½æ±‚å¼·å¤§çš„å­¤é«˜é“è·¯ï¼Œä»¤è¨±å¤šæƒ³æˆç‚ºå®¶äººçš„äººå‚·å¿ƒã€‚",
                "ã€ä¸»ç·šã€‘ã€Œ128å°æ™‚ç”œèœœçš„å®¶ã€æ­£å¼æ½°æ•£ï¼Œæ·ªç‚ºä¼‘æ¯ç«™è€Œéæ­¸å®¿ã€‚æ¯›å‰‡æœªå—å½±éŸ¿ï¼Œå°ˆå¿ƒå›¤ç©ç·šä¸‹èšæœƒç¦®ç‰©ã€‚"
            ],
            act3: [
                "ã€ä¸»ç·šã€‘è³‡æºè¦‹åº•ï¼Œå®¹éŒ¯ç‡é™è‡³ 0%ã€‚æ§æˆ°å¹«èˆ‡æ¥“è°·å¹«ç”¢ç”Ÿåš´é‡çµæ§‹æ€§åˆ†æ­§ã€‚",
                "ã€ä¸»ç·šã€‘éš±åˆºèŸ²ä»—è‘—ã€ç„¡é‚Šç•Œæ„Ÿã€‘ç‰¹æ€§ï¼ŒæŒçºŒç™¼å¸ƒå¾®é‡ç²¾ç¥å‚·å®³ã€‚",
                "ã€ä¸»ç·šã€‘åœŸè±†çš„ã€å®¹å¿è¨ˆæ•¸å™¨ã€‘æ»¿è¼‰ï¼Œä»¥æ–¬æ–·åå¹´å‹èª¼ç‚ºä»£åƒ¹ï¼Œç™¼å‹•çµ‚æ¥µæŠ€èƒ½ã€‚",
                "ã€ä¸»ç·šã€‘éš±åˆºèŸ²é­æ°¸ä¹…éœéŸ³ä¸¦é©…é€ï¼Œä¿±æ¨‚éƒ¨å–ªå¤±é‡è¦ç‰½åˆ¶æˆ°åŠ›ï¼Œå…§éƒ¨éˆçµæ–·è£‚ã€‚",
                "ã€ä¸»ç·šã€‘æ¯›æ»¿æ‡·æœŸå¾…å¸¶è‘—é«˜éšç¦®ç‰©å‰å¾€ç·šä¸‹èšæœƒã€‚",
                "ã€ä¸»ç·šã€‘æ•µå°å‹¢åŠ›å°ä¸­å¹«ç™¼å‹•æœ€é«˜éšç’°å¢ƒç½é›£ï¼šã€13-0 çµ•å°å¤±ç´„ã€‘ã€‚",
                "ã€ä¸»ç·šã€‘æ¯›çš„å¿ƒæ„é­å¾¹åº•è¾œè² ï¼Œç†æ™ºæ–·ç·šï¼Œè§¸ç™¼å°ˆå±¬è¢«å‹•ã€å¤–å‹è¡æ’æœ¬èƒ½ã€‘ã€‚",
                "ã€ä¸»ç·šã€‘ç„¡è¦–é˜²ç¦¦çš„ç„¡å·®åˆ¥çœŸå¯¦å‚·å®³çˆ†ç™¼ï¼Œå°ä¼ºæœå™¨é€ æˆä¸å¯é€†çš„æ¯€æ»…æ€§æ‰“æ“Šã€‚"
            ]
        };

        const INCIDENT_STAGES = {
            3: { title: "D3: é­å—7000å­—ä½œæ–‡æ”»æ“Š", content: "åµæ¸¬åˆ°æ•µå°å–®ä½ï¼ˆç™½ç™¡ç”·æ€§ï¼‰ï¼Œå› ç‚ºå°é˜¿é›æšˆèˆ¹æƒ³å‘å¥¹é“æ­‰å¯«äº†7000å­—è¶…é•·ä½œæ–‡ã€‚", color: "text-red-500" },
            4: { title: "D4: å—åˆ°7000å­—å¤§è¦æ¨¡è½Ÿç‚¸", content: "ã€Œ7000å­—é“æ­‰æ–‡ã€é–‹å§‹å»£åŸŸç²¾ç¥æ±¡æŸ“ã€‚å…¨é«”æˆå“¡ SAN å€¼æ€¥é€Ÿä¸‹é™,è«‹è¶•å¿«åˆ°é˜¿è‹±ç‚’éºµè£œå……ã€‚", color: "text-orange-500" },
            5: { title: "D5: æˆ°ç•¥åƒµæŒéšæ®µ", content: "ç¾¤çµ„é¦–æ¬¡æˆ°ç•¥é›†çµã€‚å¤§å®¶é–‹å§‹è²è¨7000å­—ç™½ç™¡ç”·æ€§,ä½†ä¹Ÿå› æ­¤å—åˆ°å½±éŸ¿é–‹å§‹æ‰¿å—ä¸¦æ¶ˆè€—èƒ½é‡,æœ€å¾Œå¤§å®¶éƒ½æƒ¡åŒ–è®Šæˆç™½ç™¡...", color: "text-yellow-500" },
            6: { title: "D6: é˜²ç¦¦æˆåŠŸèˆ‡è½‰é€²", content: "ç™½ç™¡ç”·æ€§(å…¥ä¾µè€…)AP è€—ç›¡ï¼Œå•Ÿå‹•ç‰©ç†éš”é›¢ã€‚ä¸»æˆ°å ´é–å®šç‚ºã€Œæ§æˆ°é »é“ (ç“¦ç¾…è˜­)ã€ï¼Œé€²å…¥ç¬¬ä¸€ç« ã€‚", color: "text-green-500" }
        };

        const FloatingText = ({ text, x, y, type }) => (
            <div className={`fixed pointer-events-none animate-float-up font-bold text-lg z-[100] drop-shadow-md ${type === 'damage' ? 'text-red-500 text-xl font-black' : type === 'heal' ? 'text-green-400' : type === 'ebl' ? 'text-purple-400 text-xl font-black' : 'text-yellow-400'}`} style={{ left: x, top: y, transform: 'translate(-50%, -50%)' }}>{text}</div>
        );

        // --- Main System ---
        function EmotionalBlackmailClub() {
            const [gameState, setGameState] = useState('start');
            const [hero, setHero] = useState(null);
            
            const [resources, setResources] = useState({ san: 100, ebl: 0, gold: 3 });
            const [members, setMembers] = useState(INITIAL_MEMBERS);
            const [logs, setLogs] = useState([]);
            
            const [turnDisplay, setTurnDisplay] = useState(0); 
            const turnRef = useRef(1);
            const shelterUsageRef = useRef(0);
            const latteSkillCountRef = useRef(0);
            const isProcessing = useRef(false);
            
            const [activeEffect, setActiveEffect] = useState(null);
            const [activeIncident, setActiveIncident] = useState(null);
            const [showRules, setShowRules] = useState(false);
            const [showTargetModal, setShowTargetModal] = useState(false);
            const [showMembersModal, setShowMembersModal] = useState(false);
            const [floatingTexts, setFloatingTexts] = useState([]);
            const logsEndRef = useRef(null);

            useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);

            const triggerVisualEffect = (eff) => { setActiveEffect(eff); setTimeout(() => setActiveEffect(null), 500); };
            const spawnFloatingText = (text, type) => {
                const id = Date.now() + Math.random(); 
                const x = '50%'; 
                const y = '40%'; 
                setFloatingTexts(prev => [...prev, { id, text, x, y, type }]);
                setTimeout(() => setFloatingTexts(prev => prev.filter(ft => ft.id !== id)), 1500);
            };

            const setMemberStatus = useCallback((id, status) => {
                setMembers(prev => prev.map(m => m.id === id ? { ...m, status } : m));
                try{ playSound('glitch'); } catch(e){}
                triggerVisualEffect('glitch');
            }, []);

            const evaluateEnding = useCallback((forcedEnding = false) => {
                const active = members.filter(m => m.status === 'active').length;
                const total = members.filter(m => m.status !== 'hidden').length;
                const rate = active / total;
                const currentSan = resources.san;

                if (forcedEnding || currentSan <= 60 || rate < 0.5) setGameState('ending_A');
                else if (latteSkillCountRef.current >= 10) setGameState('ending_B');
                else if (currentSan >= 100 && currentSan <= 105) setGameState('ending_C');
                else if (currentSan > 110 && rate >= 0.8) setGameState('ending_D');
                else setGameState('ending_A'); 
            }, [members, resources.san]);

            const advanceChapter = useCallback((currentAct) => {
                turnRef.current = 1;
                setTurnDisplay(0);
                shelterUsageRef.current = 0;
                setResources(p => ({ ...p, san: 100 }));
                
                if (currentAct === 'act1') {
                    setGameState('act2'); 
                    setLogs(prev => [...prev, { text: 'ã€ç¬¬äºŒç« ï¼šæƒ…æ„Ÿå‰å‰Šã€‘é–‹å§‹ã€‚', type: 'chapter', timestamp: 'SYS' }]);
                } else if (currentAct === 'act2') {
                    setGameState('act3'); 
                    setLogs(prev => [...prev, { text: 'ã€ç¬¬ä¸‰ç« ï¼šé‚Šç•Œå´©å¡Œã€‘é–‹å§‹ã€‚', type: 'chapter', timestamp: 'SYS' }]);
                } else if (currentAct === 'act3') {
                    evaluateEnding();
                }
            }, [evaluateEnding]);

            const triggerStoryHook = useCallback((act, index) => {
                if (act === 'act1' && index === 7) { setMemberStatus('wang', 'æ»¾è›‹äº†'); setMemberStatus('sora', 'æ·¡å‡º'); }
                if (act === 'act2' && index === 4) { setMemberStatus('incheon', 'active'); }
                if (act === 'act3' && index === 3) { setMemberStatus('insect', 'è¢«å°å°'); setMemberStatus('potato', 'è‡ªé–‰ä¸­'); }
                if (act === 'act3' && index === 6) {
                    spawnFloatingText(`ä¼ºæœå™¨å´©æ½° -40`, 'damage');
                    triggerVisualEffect('shake');
                    setResources(p => ({ ...p, san: p.san - 40 })); 
                }
            }, [setMemberStatus]);

            const triggerFastForward = useCallback((act) => {
                isProcessing.current = true;
                try{ playSound('glitch'); }catch(e){}
                triggerVisualEffect('glitch');
                
                const lines = STORY_LINES[act];
                const currentTurn = turnRef.current;
                const startIdx = currentTurn - 1;
                const remainingLogs = [];

                if (lines && startIdx < lines.length) {
                    for (let i = startIdx; i < lines.length; i++) {
                        remainingLogs.push({ text: lines[i], type: 'story', timestamp: `SYS` });
                        triggerStoryHook(act, i);
                    }
                }

                setLogs(prev => [...prev, ...remainingLogs]);

                setTimeout(() => {
                    advanceChapter(act);
                    isProcessing.current = false;
                }, 2500);
            }, [triggerStoryHook, advanceChapter]);

            useEffect(() => {
                if (!gameState.startsWith('act') || isProcessing.current) return;
                
                if (resources.san <= 60) {
                    setLogs(prev => [...prev, { text: 'ã€å¸æ”¶å£ B è§¸ç™¼ã€‘SAN è·Œç ´é–¾å€¼ï¼Œç³»çµ±ç„¡æ³•æ‰¿å—ç’°å¢ƒæ¯’æ€§ï¼Œå¼·åˆ¶é€²å…¥çµç®—ç¨‹åºã€‚', type: 'alert', timestamp: 'SYS' }]);
                    isProcessing.current = true;
                    setTimeout(() => evaluateEnding(true), 2000);
                }
            }, [resources.san, gameState, evaluateEnding]);

            const handleChannelAction = (channel) => {
                if (isProcessing.current || activeIncident || !gameState.startsWith('act')) return;
                
                const isGoodOutcome = Math.random() >= 0.5;
                const sanChange = isGoodOutcome ? 5 : -5;
                const actionText = isGoodOutcome 
                    ? channel.good[Math.floor(Math.random() * channel.good.length)]
                    : channel.bad[Math.floor(Math.random() * channel.bad.length)];

                if (isGoodOutcome) {
                    try{ playSound('heal'); }catch(e){}
                    spawnFloatingText(`SAN +5`, 'heal');
                } else {
                    try{ playSound('damage'); }catch(e){}
                    triggerVisualEffect('shake');
                    spawnFloatingText(`SAN -5`, 'damage');
                }

                let goldChange = 0; let eblChange = 0;
                if (channel.type === 'leisure' && !isGoodOutcome) { goldChange = -1; spawnFloatingText('Gold -1', 'gold'); }

                const newSan = resources.san + sanChange;
                let finalEbl = resources.ebl + eblChange;

                if (newSan >= 115) {
                    finalEbl += 1;
                    spawnFloatingText(`æƒ…å‹’å€¼ +1`, 'ebl');
                }

                setResources(prev => ({ san: newSan, gold: Math.max(0, prev.gold + goldChange), ebl: finalEbl }));

                const currentTurn = turnRef.current;
                setTurnDisplay(currentTurn);
                turnRef.current += 1;

                const lines = STORY_LINES[gameState];
                const storyText = (lines && currentTurn <= lines.length) ? lines[currentTurn - 1] : null;
                
                if (storyText) {
                    triggerStoryHook(gameState, currentTurn - 1);
                }

                setLogs(prev => {
                    const newLogs = [...prev];
                    newLogs.push({ text: `ã€${channel.name}ã€‘${actionText}`, type: 'normal', timestamp: `D${currentTurn}` });
                    if (storyText && !(gameState === 'act1' && currentTurn === 3)) {
                        newLogs.push({ text: storyText, type: 'story', timestamp: `D${currentTurn}` });
                    }
                    return newLogs;
                });

                if (newSan >= 115) {
                    triggerFastForward(gameState);
                    return;
                }

                if (gameState === 'act1' && currentTurn === 3) {
                    setTimeout(() => {
                        setActiveIncident(3);
                        triggerVisualEffect('glitch');
                        try{ playSound('glitch'); }catch(e){}
                    }, 500);
                }
            };

            const handleIncidentNext = () => {
                try{ playSound('click'); }catch(e){}
                const nextStep = activeIncident + 1;
                const stage = INCIDENT_STAGES[activeIncident];
                setLogs(prev => [...prev, { text: `ã€äº‹ä»¶ã€‘${stage.title}: ${stage.content}`, type: 'story', timestamp: `D${activeIncident}` }]);

                if (nextStep <= 6) {
                    setActiveIncident(nextStep);
                } else {
                    setActiveIncident(null);
                    setTurnDisplay(7);
                    turnRef.current = 8;
                }
            };

            const visitShelter = () => {
                if (isProcessing.current || !gameState.startsWith('act') || activeIncident) return;
                if (shelterUsageRef.current >= 3) {
                    setLogs(prev => [...prev, { text: 'ã€æ‹’çµ•å­˜å–ã€‘é˜¿è‹±é˜¿å§¨èªªæœ¬ç« çš„ç‚’éºµå·²ç¶“è³£å®Œäº†ã€‚', type: 'alert', timestamp: 'SYS' }]);
                    return;
                }
                if (resources.gold >= SHELTER.cost) {
                    try{ playSound('heal'); }catch(e){}
                    spawnFloatingText(`SAN +15`, 'heal');
                    spawnFloatingText(`Gold -1`, 'gold');
                    
                    const newSan = resources.san + 15;
                    let finalEbl = resources.ebl;

                    if (newSan >= 115) {
                        finalEbl += 1;
                        spawnFloatingText(`æƒ…å‹’å€¼ +1`, 'ebl');
                    }

                    setResources(prev => ({ ...prev, gold: prev.gold - SHELTER.cost, san: newSan, ebl: finalEbl }));
                    shelterUsageRef.current += 1;
                    setLogs(prev => [...prev, { text: `æ¶ˆè²» 1 Gold é£Ÿç”¨é˜¿è‹±ç‚’éºµï¼Œç†æ™ºæ¢å¾©ã€‚(æœ¬ç« å‰©é¤˜: ${3 - shelterUsageRef.current})`, type: 'heal', timestamp: `SYS` }]);

                    if (newSan >= 115) {
                        triggerFastForward(gameState);
                    }
                } else {
                    setLogs(prev => [...prev, { text: 'ã€é¤˜é¡ä¸è¶³ã€‘ç„¡æ³•è³¼è²·é¿é›£æ‰€ç‰©è³‡ã€‚', type: 'alert', timestamp: 'SYS' }]);
                }
            };

            const openTargetModal = () => {
                if (isProcessing.current || !gameState.startsWith('act') || activeIncident) return;
                if (resources.ebl < 1) { 
                    setLogs(prev => [...prev, { text: 'ã€æ¢ä»¶æœªæ»¿ã€‘æƒ…å‹’å€¼(EBL)ä¸è¶³ 1ï¼Œç„¡æ³•ç™¼å‹•å¤§çµ•æ‹›ã€‚', type: 'alert', timestamp: 'SYS' }]);
                    return; 
                }
                setShowTargetModal(true);
            };

            const executeUltimateSkill = (target) => {
                setShowTargetModal(false);
                try{ playSound('skill_heavy'); }catch(e){}
                triggerVisualEffect('glitch');
                
                let sanHeal = 0;
                let skillLogText = '';
                if (hero.id === 'latte') {
                    latteSkillCountRef.current += 1;
                    sanHeal = 30;
                } else if (hero.id === 'mao') {
                    sanHeal = 5;
                } else if (hero.id === 'caitou') {
                    sanHeal = 10;
                } else if (hero.id === 'meow') {
                    sanHeal = 25;
                }
                
                skillLogText = `ç™¼å‹•å¤§çµ•æ‹›ï¼šã€${hero.skill}ã€‘ç—›æ‰äº† [${target.name}]ï¼ (SAN+${sanHeal})`;

                const newSan = resources.san + sanHeal;
                let finalEbl = resources.ebl - 1;

                if (newSan >= 115) {
                    finalEbl += 1;
                    spawnFloatingText(`æƒ…å‹’å€¼ +1`, 'ebl');
                }

                setResources(prev => ({ ...prev, san: newSan, ebl: finalEbl }));
                spawnFloatingText(`SAN +${sanHeal}`, 'heal');
                
                const currentTurn = turnRef.current;
                setTurnDisplay(currentTurn);
                turnRef.current += 1;

                setLogs(prev => [
                    ...prev, 
                    { text: skillLogText, type: 'skill', timestamp: `D${currentTurn}` },
                    { text: `ã€${target.name}ã€‘: ã€Œå°ä¸èµ·å°ä¸èµ·æˆ‘éŒ¯äº†ï¼æ‹œè¨—æ”¾éæˆ‘ï¼å•Šå•Šå•Šå•Šï¼ã€ (ç˜‹ç‹‚æ±‚é¥’)`, type: 'alert', timestamp: `D${currentTurn}` }
                ]);

                if (newSan >= 115) {
                    triggerFastForward(gameState);
                }
            };

            const onlineMembers = members.filter(m => m.status === 'active' || m.status === 'npc');
            const offlineMembers = members.filter(m => m.status !== 'active' && m.status !== 'npc' && m.status !== 'hidden');

            if (gameState === 'start') {
                return (
                    <div className="flex flex-col items-center justify-start min-h-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-indigo-950 via-gray-900 to-black text-white p-4 sm:p-8 overflow-y-auto custom-scrollbar">
                        <div className="max-w-6xl w-full flex flex-col items-center py-6">
                            <h1 className="text-4xl sm:text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-br from-pink-500 via-red-500 to-yellow-500 tracking-widest glitch-text z-10 text-center drop-shadow-[0_0_20px_rgba(236,72,153,0.5)] leading-tight mb-2">æƒ…å‹’ä¿±æ¨‚éƒ¨</h1>
                            <h2 className="text-lg sm:text-2xl text-pink-400 font-bold tracking-widest z-10 animate-pulse drop-shadow-md text-center mb-10">æ­¡è¿ä¾†åˆ°æº«æ…¢çš„æƒ…å‹’ä¿±æ¨‚éƒ¨&gt;&lt;</h2>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 w-full z-10">
                                {PROTAGONISTS.map(p => (
                                <button key={p.id} onClick={() => {setHero(p); setGameState('act1'); try{playSound('click');}catch(e){}}} className={`group relative p-6 border border-gray-700/50 rounded-2xl bg-gray-900/80 backdrop-blur-sm transition-all hover:-translate-y-1 text-left ${p.glow} shadow-xl flex flex-col min-h-[300px]`}>
                                    <div className="text-4xl mb-4 group-hover:scale-110 transition-transform duration-300">{p.skillIcon}</div>
                                    <h3 className={`text-xl font-black mb-1 tracking-wide ${p.id === 'meow' ? 'text-pink-400' : 'text-white'}`}>{p.name}</h3>
                                    <p className="text-[10px] text-gray-500 font-mono mb-3 border-b border-gray-700 pb-1 uppercase">{p.role}</p>
                                    <div className="overflow-y-auto custom-scrollbar flex-grow pr-1">
                                        <p className="text-xs text-gray-300 leading-relaxed">{p.desc}</p>
                                    </div>
                                </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState.startsWith('ending')) {
                const endingConfig = {
                    'ending_A': { title: 'çµå±€ A: å¯‚éœçš„ä¼ºæœå™¨', desc: 'ç’°å¢ƒæ¯’æ€§è¶…è¼‰æˆ–ç”Ÿæ…‹ç³»å´©æ½°ï¼Œé »é“å·²æˆæ­»åŸã€‚æ‰€æœ‰çš„æƒ…å‹’æœ€çµ‚åªæ›ä¾†äº†è™›ç„¡ã€‚', color: 'text-gray-500' },
                    'ending_B': { title: 'çµå±€ B: ç„¡é–“é“è¼ªè¿´', desc: 'å‰å‰Šæ©Ÿåˆ¶éåº¦å•Ÿå‹•ï¼Œå¢®å…¥ç„¡é™çš„äº’ç›¸å‚·å®³è¿´åœˆã€‚', color: 'text-red-500' },
                    'ending_C': { title: 'çµå±€ C: éµè¡€çƒæ‰˜é‚¦', desc: 'çµ•å°é‚Šç•Œå£“åˆ¶æˆåŠŸï¼Œæˆç‚ºç¼ºä¹äººæ€§çš„é«˜å¼·åº¦é‹ä½œæ©Ÿå™¨ã€‚å®Œç¾åŸ·è¡Œäº†ä¸»å¸­çš„é«˜å£“ç¨è£ã€‚', color: 'text-blue-500' },
                    'ending_D': { title: 'çµå±€ D: è™›å‡çš„çœŸå¯¦', desc: 'ä»¥è™›æ§‹çš„æº«æš–æ©è“‹æ·±å±¤çŸ›ç›¾ï¼Œè¿ä¾†è™›å‡çš„ç¹æ¦®ã€‚ä½ æˆåŠŸç¶­æŒäº†è¡¨é¢çš„å’Œè«§ï¼Œå„˜ç®¡å¤§å®¶éƒ½çŸ¥é“é€™åªæ˜¯å¹»å½±ã€‚', color: 'text-purple-400' }
                };
                const ec = endingConfig[gameState] || endingConfig['ending_A'];
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-900 via-black to-black text-white p-6 text-center">
                        <h1 className="text-3xl sm:text-5xl font-black text-gray-600 tracking-widest uppercase drop-shadow-xl mb-4">Simulation Terminated</h1>
                        <h2 className={`text-4xl sm:text-6xl font-black ${ec.color} drop-shadow-[0_0_15px_rgba(255,255,255,0.1)] mb-6`}>{ec.title}</h2>
                        <p className="text-sm sm:text-xl text-gray-400 font-mono max-w-2xl leading-relaxed mb-10">{ec.desc}</p>
                        <button onClick={() => window.location.reload()} className="px-8 py-4 bg-gray-800 border border-gray-600 font-bold text-gray-200 hover:text-white hover:bg-gray-700 rounded-xl transition-all shadow-xl text-lg tracking-widest">é‡æ–°é–‹å§‹</button>
                    </div>
                );
            }

            return (
                <div className={`h-screen flex flex-col overflow-hidden relative text-white bg-black ${activeEffect === 'shake' ? 'animate-shake' : activeEffect === 'glitch' ? 'animate-glitch-screen' : ''}`}>
                    {floatingTexts.map(ft => <FloatingText key={ft.id} text={ft.text} x={ft.x} y={ft.y} type={ft.type} />)}

                    {/* Rules Modal */}
                    {showRules && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
                            <div className="bg-gradient-to-b from-gray-900 to-gray-950 border border-gray-700 w-full max-w-lg rounded-2xl p-6 sm:p-8 relative shadow-[0_0_40px_rgba(0,0,0,0.8)]">
                                <button onClick={() => setShowRules(false)} className="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors"><X size={24}/></button>
                                <h2 className="text-xl sm:text-2xl font-black text-white mb-6 flex items-center"><Shield className="mr-3 text-blue-500"/> è¦å‰‡èªªæ˜</h2>
                                <div className="space-y-4 text-gray-300 font-mono text-xs sm:text-sm leading-relaxed max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                                    <div className="border-l-2 border-red-500 pl-4 bg-red-950/10 py-2 rounded-r">
                                        <strong className="text-red-400 block mb-1">ç©©å®šåº¦ (SAN)</strong> 
                                        é»æ“Šé »é“æ™‚ 50% è§¸ç™¼å–„æƒ¡äº‹ä»¶ï¼Œå°æ‡‰ SAN Â±5ã€‚<br/>
                                        ä¸Šé™ï¼šé”åˆ° 115 å°‡è‡ªå‹•é€²å…¥ä¸‹ä¸€å€‹ç« ç¯€ã€‚<br/>
                                        å±éšªï¼šä½æ–¼ 60(å«) å°‡æœƒç›´æ¥å°è‡´éŠæˆ²çµæŸã€‚
                                    </div>
                                    <div className="border-l-2 border-orange-500 pl-4 bg-orange-950/10 py-2 rounded-r">
                                        <strong className="text-orange-400 block mb-1">é˜¿è‹±é¿é›£æ‰€</strong>
                                        æ¯ç« ç¯€é™ 3 æ¬¡ï¼Œæ¶ˆè€— 1 é‡‘å¹£æ›å– 15 é» SAN å€¼æ¢å¾©ã€‚
                                    </div>
                                    <div className="border-l-2 border-purple-500 pl-4 bg-purple-950/10 py-2 rounded-r">
                                        <strong className="text-purple-400 block mb-1">å¤§çµ•æ‹›</strong>
                                        ç²å¾— 1 é»æƒ…å‹’å€¼ (EBL) å¾Œå¯å°ç‰¹å®šæˆå“¡ç™¼å‹•æ”»æ“Šä¸¦ç²å–å¤§é‡ SAN å›å¾©ã€‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Target Selection Modal */}
                    {showTargetModal && (
                        <div className="fixed inset-0 z-[250] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-gray-900 border border-purple-500 w-full max-w-md rounded-2xl p-6 shadow-[0_0_30px_rgba(168,85,247,0.4)]">
                                <h2 className="text-lg sm:text-xl font-black text-purple-400 mb-4 tracking-widest text-center">é¸æ“‡ç—›æ‰ç›®æ¨™</h2>
                                <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar pr-2 mb-4">
                                    {onlineMembers.map(m => (
                                        <button key={m.id} onClick={() => executeUltimateSkill(m)} className="w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-purple-900/50 border border-gray-700 hover:border-purple-500 transition-all flex justify-between items-center group">
                                            <span className="font-bold text-gray-200 group-hover:text-white text-sm">{m.name}</span>
                                            <span className="text-[10px] text-gray-500 group-hover:text-purple-300">{m.role}</span>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setShowTargetModal(false)} className="w-full py-3 bg-gray-800 hover:bg-gray-700 text-gray-400 font-bold rounded-lg transition-all text-sm">å–æ¶ˆ</button>
                            </div>
                        </div>
                    )}

                    {/* Mobile Members Modal */}
                    {showMembersModal && (
                        <div className="fixed inset-0 z-[250] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 lg:hidden">
                            <div className="bg-gray-900 border border-indigo-900/50 w-full max-w-md rounded-2xl p-6 shadow-[0_0_30px_rgba(99,102,241,0.4)] flex flex-col h-[80vh]">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-black text-indigo-400 tracking-widest uppercase">æˆå“¡åˆ—è¡¨</h2>
                                    <button onClick={() => setShowMembersModal(false)} className="text-gray-500 hover:text-white transition-colors"><X size={24}/></button>
                                </div>
                                <div className="overflow-y-auto custom-scrollbar flex-grow pr-2">
                                    <div className="text-[10px] font-black text-green-500 uppercase tracking-widest mb-4 drop-shadow-md">ç·šä¸Šæˆå“¡</div>
                                    <div className="space-y-2.5 mb-6">
                                        {onlineMembers.map(member => (
                                            <div key={member.id} className="flex items-center space-x-3 p-3 rounded-xl border bg-gray-800/80 border-gray-700">
                                                <div className={`w-2 h-2 rounded-full ${member.status === 'active' ? 'bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.8)]' : 'bg-blue-400 animate-pulse'}`}></div>
                                                <div className="overflow-hidden">
                                                    <div className="text-xs font-bold text-gray-100 truncate">{member.name}</div>
                                                    <div className="text-[9px] text-gray-500 truncate">{member.role}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="text-[10px] font-black text-gray-600 uppercase tracking-widest mb-4 drop-shadow-md">é›¢ç·š / å·²ç™»å‡º</div>
                                    <div className="space-y-2.5">
                                        {offlineMembers.map(member => (
                                            <div key={member.id} className="flex items-center space-x-3 p-3 rounded-xl border bg-black/50 border-gray-800/50 opacity-40 grayscale">
                                                <div className="w-2 h-2 rounded-full bg-red-800"></div>
                                                <div className="overflow-hidden">
                                                    <div className="text-xs font-bold text-gray-600 line-through truncate">{member.name}</div>
                                                    <div className="text-[9px] text-gray-700 truncate">{member.role}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* D3-D6 Incident Modal */}
                    {activeIncident && (
                        <div className="fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md">
                            <div className="bg-gray-900 border border-gray-700 w-full max-w-2xl rounded-2xl p-6 sm:p-10 font-mono shadow-[0_0_50px_rgba(0,0,0,0.8)]">
                                <h3 className={`text-xl sm:text-2xl mb-4 flex items-center font-black ${INCIDENT_STAGES[activeIncident].color}`}>
                                    <AlertTriangle className="mr-3 animate-pulse" size={32}/> {INCIDENT_STAGES[activeIncident].title}
                                </h3>
                                <div className="text-gray-300 mb-8 min-h-[100px] text-sm sm:text-lg leading-relaxed bg-black/30 p-4 sm:p-6 rounded-lg border border-gray-800">{INCIDENT_STAGES[activeIncident].content}</div>
                                <button onClick={handleIncidentNext} className="w-full py-4 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600 border border-gray-600 text-white font-bold text-lg rounded-xl transition-all tracking-widest">
                                    ä¸‹ä¸€æ­¥
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="h-auto sm:h-16 bg-gradient-to-r from-gray-950 to-gray-900 border-b border-gray-800 flex flex-col sm:flex-row items-center justify-between px-4 py-3 sm:py-0 z-10 shrink-0 shadow-md gap-4 sm:gap-0">
                        <div className="flex items-center justify-between w-full sm:w-auto space-x-4">
                            <div className="flex items-center">
                                <span className="text-red-500 font-black italic text-xl tracking-tighter sm:border-r sm:border-gray-800 sm:pr-4 leading-none pt-1">æƒ…å‹’ä¿±æ¨‚éƒ¨</span>
                                <div className="hidden sm:flex items-center space-x-2 ml-4">
                                    <span className="text-[10px] bg-gray-800 px-2 py-1 rounded text-gray-300 font-mono border border-gray-700">DAY {turnDisplay === 0 ? 1 : turnDisplay}</span>
                                    <span className="px-2 py-1 rounded text-[10px] font-bold border border-indigo-900/50 bg-indigo-950/30 text-indigo-400 uppercase tracking-tighter">{gameState.toUpperCase()}</span>
                                </div>
                            </div>
                            
                            {/* Mobile Info Buttons */}
                            <div className="flex lg:hidden items-center space-x-2">
                                <button onClick={() => setShowRules(true)} className="p-2 bg-gray-800/50 border border-gray-700 rounded-lg text-indigo-400 active:scale-95"><Shield size={18} /></button>
                                <button onClick={() => setShowMembersModal(true)} className="p-2 bg-gray-800/50 border border-gray-700 rounded-lg text-green-400 active:scale-95"><Users size={18} /></button>
                            </div>
                        </div>
                        
                        <div className="flex items-center justify-between w-full sm:w-auto space-x-4 sm:space-x-8">
                            <div className="flex items-center space-x-2 flex-grow sm:flex-grow-0">
                                <HeartCrack className={`w-5 h-5 ${resources.san <= 65 ? 'text-red-500 animate-pulse' : 'text-pink-600'}`} />
                                <div className="flex flex-col flex-grow sm:w-28">
                                    <div className="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                                        <div className={`h-full transition-all duration-300 ${resources.san <= 60 ? 'bg-red-600' : resources.san >= 115 ? 'bg-cyan-400' : 'bg-pink-500'}`} style={{ width: `${Math.min(100, (resources.san/150)*100)}%` }}></div>
                                    </div>
                                    <span className={`text-[10px] font-bold text-right mt-0.5 ${resources.san <= 65 ? 'text-red-400' : 'text-gray-400'}`}>SAN: {resources.san}</span>
                                </div>
                            </div>
                            <div className="flex items-center space-x-4">
                                <div className="flex items-center space-x-1"><Heart className="w-4 h-4 text-purple-500" /><span className="font-bold font-mono text-sm">{resources.ebl}</span></div>
                                <div className="flex items-center space-x-1"><Coins className="w-4 h-4 text-yellow-500" /><span className="font-bold font-mono text-sm">{resources.gold}</span></div>
                            </div>
                        </div>
                    </header>

                    {/* Content Layer */}
                    <div className="flex flex-1 flex-col lg:flex-row overflow-hidden">
                        
                        {/* Mobile Channel Bar (Horizontal Scroll) */}
                        <div className="flex lg:hidden overflow-x-auto custom-scrollbar p-3 bg-gray-900 border-b border-gray-800 gap-2 shrink-0">
                            {CHANNELS.map(channel => (
                                <button key={channel.id} onClick={() => handleChannelAction(channel)} disabled={!!activeIncident || isProcessing.current} className="flex-shrink-0 flex flex-col items-center justify-center px-4 py-2 rounded-xl bg-gray-800 border border-gray-700 active:scale-95 disabled:opacity-50 min-w-[80px]">
                                    <div className={`${channel.color}`}><channel.icon size={18} /></div>
                                    <span className="text-[10px] mt-1 font-bold whitespace-nowrap">{channel.name}</span>
                                </button>
                            ))}
                            <button onClick={visitShelter} className="flex-shrink-0 flex flex-col items-center justify-center px-4 py-2 rounded-xl bg-orange-900/20 border border-orange-900/50 active:scale-95 min-w-[80px]">
                                <Utensils size={18} className="text-orange-400" />
                                <span className="text-[10px] mt-1 font-bold text-orange-400">é˜¿è‹±({3-shelterUsageRef.current})</span>
                            </button>
                        </div>

                        {/* Desktop Sidebar Left */}
                        <aside className="hidden lg:flex w-72 bg-gradient-to-b from-gray-900 to-gray-950 border-r border-indigo-900/30 p-5 flex-col space-y-3 z-10 overflow-y-auto custom-scrollbar shrink-0">
                            <div className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2 pl-1">é »é“é¸å–®</div>
                            {CHANNELS.map(channel => (
                                <button key={channel.id} onClick={() => handleChannelAction(channel)} disabled={!!activeIncident || isProcessing.current} className="group flex items-center justify-start space-x-4 p-3.5 rounded-xl bg-gray-800/80 border border-gray-700 hover:border-indigo-500/50 hover:bg-gray-800 transition-all disabled:opacity-50">
                                    <div className={`p-2 rounded-lg bg-gray-950 ${channel.color}`}><channel.icon size={20} /></div>
                                    <div className="text-left w-full"><div className={`text-sm font-bold ${channel.color}`}>{channel.name}</div></div>
                                </button>
                            ))}
                            <div className="h-px bg-gray-800 my-2"></div>
                            <button onClick={() => setShowRules(true)} className="flex items-center justify-center p-3 bg-gray-800/30 border border-gray-700 rounded-xl hover:bg-gray-800 text-gray-400 hover:text-white transition-all">
                                <Shield className="mr-2 text-indigo-500" size={16}/><span className="text-xs font-bold tracking-widest">è¦å‰‡</span>
                            </button>
                            <button onClick={visitShelter} disabled={!!activeIncident || isProcessing.current} className="flex flex-col p-4 rounded-xl bg-orange-900/10 border border-orange-900/30 hover:border-orange-500/80 transition-all mt-auto disabled:opacity-50">
                                <div className="flex items-center space-x-3 mb-2">
                                    <div className="p-2 bg-orange-900/30 rounded-lg"><Utensils size={18} className="text-orange-400" /></div>
                                    <div className="text-sm font-bold text-orange-400">{SHELTER.name} ({3 - shelterUsageRef.current})</div>
                                </div>
                                <div className="text-[10px] text-gray-500 w-full text-right font-mono">-1 Gold / +15 SAN</div>
                            </button>
                            {resources.ebl >= 1 ? (
                                <button onClick={openTargetModal} className="w-full py-4 bg-gradient-to-r from-purple-600 to-purple-900 text-white rounded-xl font-bold text-xs border border-purple-500 shadow-lg mt-2">{hero?.skillIcon} å¤§çµ•æ‹›: {hero?.skill}</button>
                            ) : (
                                <button disabled className="w-full py-4 bg-gray-900 text-gray-600 rounded-xl font-bold text-xs border border-gray-800 mt-2 opacity-50 cursor-not-allowed">ğŸ”’ éœ€ 1 EBL è§£é–å¤§çµ•</button>
                            )}
                        </aside>

                        {/* Center Logs */}
                        <main className="flex-1 bg-black p-4 sm:p-6 overflow-y-auto custom-scrollbar relative">
                            <div className="space-y-4 max-w-3xl mx-auto">
                                {logs.length === 0 && (
                                    <div className="text-center py-20 opacity-30 font-mono text-sm">Waiting for connection...</div>
                                )}
                                {logs.map((log, i) => (
                                    <div key={i} className={`p-4 rounded-xl border-l-4 text-xs sm:text-sm font-mono shadow-sm transition-all ${
                                        log.type === 'alert' ? 'bg-red-950/30 border-red-500 text-red-100' :
                                        log.type === 'chapter' ? 'bg-blue-900/10 border-blue-500 text-blue-300 py-8 text-center border-l-0 border-y my-10 tracking-[0.3em] font-black text-base' :
                                        log.type === 'story' ? 'bg-indigo-950/20 border-indigo-500 text-indigo-100' :
                                        log.type === 'skill' ? 'bg-purple-950/30 border-purple-400 text-purple-200' :
                                        log.type === 'heal' ? 'bg-orange-950/20 border-orange-500 text-orange-200' :
                                        'bg-gray-900/40 border-gray-700 text-gray-300'
                                    }`}>
                                        {log.timestamp !== 'SYS' && <div className="text-[9px] text-gray-600 mb-1">[{log.timestamp}]</div>}
                                        <div className="leading-relaxed">{log.text}</div>
                                    </div>
                                ))}
                                <div ref={logsEndRef} className="h-4" />
                            </div>
                            
                            {/* Mobile Ultimate Button */}
                            {resources.ebl >= 1 && gameState.startsWith('act') && (
                                <button onClick={openTargetModal} className="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-purple-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl border-2 border-purple-400 animate-bounce z-50">
                                    {hero?.skillIcon}
                                </button>
                            )}
                        </main>

                        {/* Sidebar Right - Members */}
                        <aside className="hidden lg:flex w-72 bg-gradient-to-b from-gray-900 to-gray-950 border-l border-indigo-900/30 p-5 overflow-y-auto z-10 custom-scrollbar shrink-0">
                            <div className="text-[10px] font-black text-green-500 uppercase tracking-widest mb-4">ç·šä¸Šæˆå“¡</div>
                            <div className="space-y-2 mb-6">
                                {onlineMembers.map(member => (
                                    <div key={member.id} className="flex items-center space-x-3 p-2.5 rounded-lg bg-gray-800/50 border border-gray-700">
                                        <div className={`w-2 h-2 rounded-full ${member.status === 'active' ? 'bg-green-500 animate-pulse' : 'bg-blue-400 animate-pulse'}`}></div>
                                        <div className="overflow-hidden">
                                            <div className="text-xs font-bold text-gray-100 truncate">{member.name}</div>
                                            <div className="text-[9px] text-gray-500 truncate">{member.role}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {offlineMembers.length > 0 && (
                                <>
                                    <div className="text-[10px] font-black text-gray-600 uppercase tracking-widest mb-4">é›¢ç·š / å·²ç™»å‡º</div>
                                    <div className="space-y-2">
                                        {offlineMembers.map(member => (
                                            <div key={member.id} className="flex items-center space-x-3 p-2.5 rounded-lg bg-black/50 border border-gray-900 opacity-40 grayscale">
                                                <div className="w-2 h-2 rounded-full bg-red-800"></div>
                                                <div className="overflow-hidden">
                                                    <div className="text-xs font-bold text-gray-600 line-through">{member.name}</div>
                                                    <div className="text-[9px] text-gray-700">{member.role}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </aside>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EmotionalBlackmailClub />);
    </script>
</body>
</html>
